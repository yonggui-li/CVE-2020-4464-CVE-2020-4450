package main

import (
	"encoding/json"
	"fmt"
	"golandproj/myutils"
	"io/ioutil"
	"regexp"
	"strings"
)

var cveJson = `{
    "cve-2016-2569": 13677,
    "cve-2017-0147": 36414,
    "cve-2014-3931": 147154,
    "cve-2020-11899": 560,
    "cve-2006-3869": 1978,
    "cve-2016-0101": 1004,
    "cve-2008-1447": 3292,
    "cve-2009-0233": 3292,
    "cve-2005-0446": 1096,
    "cve-2015-1729": 6552,
    "cve-2009-0850": 142,
    "cve-2011-3230": 59,
    "cve-2011-1889": 1167,
    "cve-2017-0144": 2017,
    "cve-2008-2938": 1109,
    "cve-2009-1535": 1286,
    "cve-2018-15953": 33,
    "cve-2014-6332": 2,
    "cve-2016-7255": 13232,
    "cve-2016-2211": 13,
    "cve-2020-0601": 373,
    "cve-2010-0017": 14,
    "cve-2010-0231": 14,
    "cve-2017-0146": 144,
    "cve-2010-1635": 2,
    "cve-2016-4535": 411,
    "cve-2017-16995": 5,
    "cve-2014-6345": 1420,
    "cve-2008-2257": 16,
    "cve-2015-3008": 83,
    "cve-2009-1122": 4175,
    "cve-2017-11882": 1057,
    "cve-2013-0422": 106,
    "cve-2015-0003": 42,
    "cve-2018-8120": 252,
    "cve-2018-19320": 7,
    "cve-2016-6291": 99,
    "cve-2004-0566": 142,
    "cve-2004-0120": 13,
    "cve-2008-3018": 43,
    "cve-2008-3021": 43,
    "cve-2000-0573": 2,
    "cve-2015-2331": 19,
    "cve-2014-4114": 54,
    "cve-2017-0199": 1842,
    "cve-2014-0615": 150,
    "cve-2019-1184": 54,
    "cve-2017-5753": 19,
    "cve-2006-0025": 37,
    "cve-1999-0016": 536,
    "cve-2004-0790": 453,
    "cve-2005-0068": 453,
    "cve-2018-8453": 1124,
    "cve-2009-1128": 10,
    "cve-2015-2466": 221,
    "cve-2020-3837": 2,
    "cve-2019-1458": 8,
    "cve-2006-0003": 88,
    "cve-2007-5659": 65,
    "cve-2008-0655": 56,
    "cve-2008-2992": 56,
    "cve-2008-5353": 41,
    "cve-2009-0927": 56,
    "cve-2009-3867": 41,
    "cve-2009-4324": 42,
    "cve-2010-0188": 41,
    "cve-2010-0248": 41,
    "cve-2010-0840": 41,
    "cve-2010-0842": 41,
    "cve-2010-0866": 41,
    "cve-2010-1240": 41,
    "cve-2010-1297": 41,
    "cve-2011-2110": 57,
    "cve-2011-2140": 41,
    "cve-2011-2371": 41,
    "cve-2011-3544": 71,
    "cve-2011-3659": 41,
    "cve-2012-0500": 41,
    "cve-2012-0507": 81,
    "cve-2012-0779": 41,
    "cve-2013-5331": 18,
    "cve-2021-1675": 35,
    "cve-2005-1206": 139,
    "cve-2020-1472": 46,
    "cve-2004-1094": 2,
    "cve-2010-3227": 227,
    "cve-2017-0213": 1840,
    "cve-2018-2894": 9,
    "cve-2021-22204": 5,
    "cve-2019-8900": 6,
    "cve-2015-2545": 3,
    "cve-2006-5614": 2238,
    "cve-2012-0152": 53,
    "cve-2018-4982": 6,
    "cve-2015-2808": 15,
    "cve-2011-1249": 7,
    "cve-2012-0158": 14,
    "cve-2012-4792": 2,
    "cve-2007-0774": 16,
    "cve-2010-3281": 16,
    "cve-2011-5007": 16,
    "cve-2021-34527": 6,
    "cve-2005-0233": 90,
    "cve-2007-0943": 339,
    "cve-2008-4835": 70,
    "cve-2017-0143": 117,
    "cve-2016-5696": 7,
    "cve-2017-7285": 7,
    "cve-2021-40450": 3,
    "cve-2022-22718": 4,
    "cve-2018-8174": 3,
    "cve-2017-11774": 31,
    "cve-2017-2823": 18,
    "cve-2004-0932": 39,
    "cve-2005-0553": 63,
    "cve-2022-30190": 2,
    "cve-2010-4258": 3,
    "cve-2014-0552": 2,
    "cve-2001-0260": 18,
    "cve-2005-0560": 18,
    "cve-2012-2376": 7,
    "cve-2002-1623": 136,
    "cve-2013-2566": 136,
    "cve-2016-4140": 7,
    "cve-2022-21882": 6,
    "cve-2015-1701": 49,
    "cve-2005-3142": 9,
    "cve-2008-2249": 3,
    "cve-2005-4560": 5,
    "cve-2007-3034": 5,
    "cve-2016-2183": 11,
    "cve-2004-0842": 5,
    "cve-2021-22205": 2,
    "cve-2019-0841": 13,
    "cve-2021-36934": 6,
    "cve-2017-8570": 105,
    "cve-2006-3524": 9,
    "cve-2014-3566": 7,
    "cve-2014-3568": 4,
    "cve-2014-6271": 2,
    "cve-2010-0249": 5,
    "cve-2010-0247": 4,
    "cve-2021-1732": 10,
    "cve-2002-1090": 13,
    "cve-2021-44228": 25,
    "cve-2014-8730": 120,
    "cve-2015-2523": 3,
    "cve-2017-1188": 286,
    "cve-2018-0802": 270,
    "cve-2018-0798": 242,
    "cve-2009-2286": 4,
    "cve-2016-3948": 4,
    "cve-2010-1807": 3,
    "cve-2021-41379": 41,
    "cve-2020-0787": 10,
    "cve-2020-0796": 566,
    "cve-2015-2414": 3,
    "cve-2007-3037": 1,
    "cve-2017-9035": 2,
    "cve-2014-1767": 4,
    "cve-2013-5065": 1,
    "cve-2013-0810": 3,
    "cve-2011-1974": 6,
    "cve-2012-0002": 3,
    "cve-2008-1084": 2,
    "cve-2010-4398": 3,
    "cve-2017-0101": 4,
    "cve-2018-8639": 6,
    "cve-2015-2387": 31,
    "cve-2016-0400": 1,
    "cve-2016-0095": 2,
    "cve-2000-0778": 12,
    "cve-2010-2556": 6,
    "cve-2009-3127": 2,
    "cve-2009-3037": 4,
    "cve-2006-1309": 5,
    "cve-2010-0257": 3,
    "cve-2008-0117": 2,
    "cve-2009-0560": 1,
    "cve-2013-3940": 3,
    "cve-2013-1315": 1,
    "cve-1999-0517": 7,
    "cve-2002-0012": 7,
    "cve-2002-0013": 7,
    "cve-2005-1476": 7,
    "cve-2008-2939": 7,
    "cve-2004-0193": 1,
    "cve-2016-3309": 1,
    "cve-2019-0703": 1,
    "cve-2017-12163": 2,
    "cve-2021-40449": 7,
    "cve-2013-6449": 498,
    "cve-2015-7759": 34,
    "cve-2005-0688": 6,
    "cve-2015-0057": 37,
    "cve-2022-21999": 2,
    "cve-2013-3660": 15,
    "cve-2021-40444": 1,
    "cve-2016-5195": 6,
    "cve-2005-1211": 3,
    "cve-2015-2546": 9,
    "cve-2008-4254": 3,
    "cve-2009-2514": 1,
    "cve-2010-2862": 1,
    "cve-2010-2561": 4,
    "cve-2019-16098": 4,
    "cve-2022-22954": 1,
    "cve-2005-1766": 3,
    "cve-2003-0095": 2,
    "cve-2012-5691": 7,
    "cve-2018-0552": 5,
    "cve-2019-1164": 8,
    "cve-2006-4071": 1,
    "cve-2000-1078": 1,
    "cve-2000-1036": 2,
    "cve-2008-1436": 23,
    "cve-2012-0756": 3,
    "cve-2003-0347": 1,
    "cve-2008-3020": 1,
    "cve-2017-0040": 1,
    "cve-2007-4060": 6,
    "cve-2008-3641": 2,
    "cve-2016-0051": 8,
    "cve-2016-0189": 2,
    "cve-2021-27065": 1,
    "cve-2014-3120": 1,
    "cve-2009-2622": 43120,
    "cve-2008-2540": 1,
    "cve-2013-2465": 7,
    "cve-2012-0056": 3,
    "cve-2000-0024": 1,
    "cve-2004-1060": 3,
    "cve-2005-0752": 1,
    "cve-2015-0204": 17,
    "cve-2016-0947": 2,
    "cve-2016-1087": 2,
    "cve-2016-4126": 2,
    "cve-2016-6804": 2,
    "cve-2021-41357": 1,
    "cve-2021-34486": 1,
    "cve-2014-3567": 1,
    "cve-2016-4554": 4,
    "cve-2000-0382": 25,
    "cve-2015-1635": 4,
    "cve-2019-12259": 3,
    "cve-2019-12265": 3,
    "cve-2008-4210": 1,
    "cve-2021-33771": 1,
    "cve-1999-0678": 1,
    "cve-2020-0986": 20,
    "cve-2018-9948": 1,
    "cve-2008-2136": 26,
    "cve-2009-3129": 6,
    "cve-2009-4873": 4,
    "cve-2010-3301": 3,
    "cve-2019-1215": 2,
    "cve-2019-1219": 7,
    "cve-2020-0668": 1,
    "cve-2019-1064": 2,
    "cve-2013-3182": 2,
    "cve-2014-7911": 2,
    "cve-2006-0084": 1,
    "cve-2011-3000": 1,
    "cve-2011-0421": 1,
    "cve-2016-0007": 2,
    "cve-2019-8048": 1,
    "cve-2019-8017": 1,
    "cve-2020-0681": 1,
    "cve-2017-1000253": 1,
    "cve-2020-1054": 1,
    "cve-2014-4113": 4,
    "cve-2021-34484": 1,
    "cve-2003-0903": 1,
    "cve-2015-0078": 2,
    "cve-2015-2506": 1,
    "cve-2015-2527": 1,
    "cve-2014-6324": 1,
    "cve-2011-2005": 3,
    "cve-2014-4076": 3,
    "cve-2011-0570": 2,
    "cve-2016-7262": 5,
    "cve-2006-0007": 5,
    "cve-2007-1071": 5,
    "cve-2016-7202": 2,
    "cve-2004-0904": 4,
    "cve-2008-3015": 4,
    "cve-2010-3190": 1,
    "cve-2008-4259": 12,
    "cve-2019-1405": 4,
    "cve-2020-1313": 2,
    "cve-2019-1322": 2,
    "cve-2016-0040": 1,
    "cve-2018-19321": 1,
    "cve-2012-1723": 39,
    "cve-2012-3753": 4,
    "cve-2003-0245": 1,
    "cve-2012-0009": 2,
    "cve-2020-0683": 1,
    "cve-2021-1647": 1,
    "cve-2001-0540": 1,
    "cve-2001-0663": 1,
    "cve-2010-3148": 2,
    "cve-2017-8759": 3,
    "cve-2021-26084": 1,
    "cve-2013-0074": 2,
    "cve-2012-4170": 1,
    "cve-2010-4221": 3,
    "cve-2018-0880": 2,
    "cve-2010-2883": 12,
    "cve-2018-4878": 5,
    "cve-2017-1182": 186,
    "cve-2008-1092": 5,
    "cve-2021-36942": 1,
    "cve-2008-2922": 1,
    "cve-2010-1885": 15,
    "cve-2011-0559": 15,
    "cve-2012-0188": 15,
    "cve-2012-1889": 15,
    "cve-2012-4681": 29,
    "cve-2017-17215": 11,
    "cve-2014-6352": 25,
    "cve-2000-0071": 1,
    "cve-2012-0217": 4,
    "cve-2007-3845": 1,
    "cve-2007-3896": 1,
    "cve-2007-4041": 1,
    "cve-2007-4880": 9,
    "cve-2005-0481": 1,
    "cve-2016-7185": 1,
    "cve-2018-15982": 2,
    "cve-2005-3357": 1,
    "cve-2017-3169": 1,
    "cve-2004-0940": 1,
    "cve-2006-4144": 1,
    "cve-2018-5040": 1,
    "cve-2009-0270": 1,
    "cve-2011-0979": 1,
    "cve-2015-1328": 1,
    "cve-2010-3849": 1,
    "cve-2009-1925": 4,
    "cve-2016-0099": 9,
    "cve-2019-0803": 5,
    "cve-2015-1641": 1,
    "cve-2012-1856": 2,
    "cve-1999-0771": 1,
    "cve-2010-3333": 2,
    "cve-2013-3900": 2,
    "cve-2019-18935": 3,
    "cve-2009-3931": 1,
    "cve-2004-0549": 1,
    "cve-2009-3576": 1,
    "cve-2017-0056": 4,
    "cve-2019-0708": 4,
    "cve-2018-10088": 2,
    "cve-2021-30551": 1,
    "cve-2006-3590": 1,
    "cve-2019-6225": 5,
    "cve-2017-5715": 1,
    "cve-2017-5754": 1,
    "cve-2013-2094": 1,
    "cve-2009-2692": 2,
    "cve-2011-1823": 3,
    "cve-2018-20250": 25,
    "cve-2009-1862": 1,
    "cve-2020-6507": 1,
    "cve-2019-0808": 1,
    "cve-2016-51939": 1,
    "cve-2010-0806": 1,
    "cve-2019-0543": 1,
    "cve-2017-9798": 1,
    "cve-2019-1367": 1,
    "cve-2008-2551": 2,
    "cve-2019-1132": 3,
    "cve-2011-2462": 1,
    "cve-2009-2990": 4,
    "cve-2006-3677": 1,
    "cve-2014-0514": 1,
    "cve-2018-4990": 12,
    "cve-2010-3654": 1,
    "cve-2014-0496": 4,
    "cve-2020-16938": 1,
    "cve-2017-17562": 1,
    "cve-2013-3346": 2,
    "cve-2020-0688": 1,
    "cve-2013-3906": 2,
    "cve-2015-0311": 2,
    "cve-2015-3105": 1,
    "cve-2010-0232": 1,
    "cve-2015-8651": 1,
    "cve-2014-0322": 1,
    "cve-2015-3113": 3,
    "cve-2020-0674": 1,
    "cve-2010-2743": 1,
    "cve-2018-8440": 1,
    "cve-2017-0245": 2,
    "cve-2019-0859": 1,
    "cve-2015-2507": 1,
    "cve-2010-2568": 2,
    "cve-2017-8464": 5,
    "cve-2019-0903": 1,
    "cve-2015-4495": 1,
    "cve-2015-0816": 1,
    "cve-2017-0037": 1,
    "cve-2015-2419": 3,
    "cve-2017-0059": 1,
    "cve-2015-1538": 1,
    "cve-2012-0151": 1,
    "cve-2015-6585": 1,
    "cve-2005-1790": 1,
    "cve-2007-1036": 1,
    "cve-2013-2185": 1,
    "cve-2017-12617": 1,
    "cve-2016-3382": 1,
    "cve-2011-4885": 1,
    "cve-2016-9079": 1,
    "cve-2012-6422": 2,
    "cve-2015-0005": 1,
    "cve-2007-0041": 1,
    "cve-2010-2755": 2,
    "cve-2014-1761": 1,
    "cve-2012-2539": 1,
    "cve-2015-1722": 2,
    "cve-2009-0563": 2,
    "cve-2010-3544": 1,
    "cve-2013-0431": 1,
    "cve-2011-0611": 1,
    "cve-2011-3402": 1
}`

func main() {
	m := map[string]int{}
	err := json.Unmarshal([]byte(cveJson), &m)
	if err != nil {
		panic(err)
	}

	descpath := "C:\\Users\\yonggui_li\\Downloads\\description1.json"
	descbyte, err := ioutil.ReadFile(descpath)
	if err != nil {
		panic(err)
	}
	descm := map[string]interface{}{}
	err = json.Unmarshal(descbyte, &descm)
	if err != nil {
		panic(err)
	}

	nscvem := map[string]bool{}
	for _, v := range descm {
		submap := v.(map[string]interface{})
		// 提取cves字段
		cvesItem := submap["cves"].([]interface{})
		for _, item := range cvesItem {
			nscvem[item.(string)] = true
		}
		// 提取reference字段
		refs := submap["references"].([]interface{})
		ptn := regexp.MustCompile(`cve,(CVE-)?[0-9]+-[0-9]+`)
		for _, item := range refs {
			items := item.(string)
			res := ptn.FindStringSubmatch(items)
			if len(res) == 0 {
				continue
			}
			cve := strings.Split(items, ",")[1]
			if strings.Contains(cve, "CVE-") {
				nscvem[cve] = true
			} else {
				nscvem["CVE-"+cve] = true
			}
		}
	}
	var pl = myutils.SortMapByIntValueASC(m)

	length := len(pl)
	count := 0
	file, index := myutils.NewExcelFile()
	file.SetCellValue("Sheet1", "A1", "CVE编号")
	file.SetCellValue("Sheet1", "B1", "样本数量")
	file.SetCellValue("Sheet1", "C1", "NS是否覆盖")
	file.SetCellValue("Sheet1", "D1", "攻击向量")
	file.SetCellValue("Sheet1", "E1", "是否有POC")
	for i := length - 1; i >= 0; i-- {
		//fmt.Println(pl[i].Key, pl[i].Value)
		//if count > 30 {
		//	break
		//}
		//if count <= 30 {
		//	continue
		//}
		//if count > 60 {
		//	break
		//}
		cve := strings.ToUpper(pl[i].Key)
		// attack vector
		av := myutils.GetNvdAV(cve)
		if !nscvem[cve] && av == "NETWORK" {
			count++
			//fmt.Println(cve, pl[i].Value, av)
			myutils.SaveInfosToExcel(file, count+1, strings.ToUpper(pl[i].Key), pl[i].Value, "未覆盖", av)

		}
	}
	myutils.SaveFile(file, "./res.xlsx", index)
	fmt.Println(count)
}
